pipeline {

  agent any

  environment {
   project = "aircall"
   project_directory = "code"
   tag = "${BUILD_NUMBER}"
   deploy_version = "function-${tag}.zip"
   s3_bucket = "aircall-artifacts"

  }

  stages {

    stage ('Clean Workspace') {
      steps{
        step([$class: 'WsCleanup'])
        checkout scm
      }
    }


    stage ('npm build and package') {
      steps {
          dir("${project_directory}"){
                sh 'npm install'
                sh 'ls'
                sh "zip -r ${deploy_version} ./"
                sh "ls -l ${deploy_version}"
          }
      }
    }

    stage ('S3 Copy Artifacts ') {
      when {
        expression { params.push_artifacts == 'yes' }
      }
      steps {
        dir("${project_directory}"){
            sh "aws s3 cp ${deploy_version} s3://${s3_bucket}/" 
        }
      }
    }

    stage ('Deploy') {
      when {
        expression { params.application_deploy == 'yes' }
      }
      steps {
        build (job: "${application_deploy_jobname}", wait: true,
        parameters: [
          string(name: 'environment', value: environment),
          string(name: 'region', value: region),
          string(name: 'lambda_s3_key', value: deploy_version),
        ])
      }
    }
  }
}