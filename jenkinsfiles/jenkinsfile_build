pipeline {

  agent any

  /*
    This Jenkinsfile is for build and deploy
    Expected variables:
    s3_bucket: s3 bucket to store artifacts
    environment: environment name to deploy
    region: aws region
    lambda_deploy: whether to deploy lambda or not
    lambda_job_name: jenkins job to deploy
  */
/*
 tools {
   maven 'maven-3.5.4'
  // jdk 'jdk8'
 }
*/

 environment {
   project = "aircall"
   project_directory = "code"
   tag = "${BUILD_NUMBER}"
   deploy_version = "function-${tag}.zip"

 }

  stages {

    stage ('Clean Workspace') {
      steps{
        step([$class: 'WsCleanup'])
        checkout scm
      }
    }


    stage ('npm build and package') {
      steps {
          dir("${project_directory}"){
                sh 'npm install'
                sh 'ls'
                sh "zip -r ${deploy_version} ./"
                sh "ls -l ${deploy_version}"
          }
      }
    }

/*
    stage ('S3 Deploy') {
      steps {
        sh 'mv target/avatar-file-data-loader* avatar-file-dataloader-${tag}.jar'
        sh 'aws s3 cp avatar-file-dataloader-${tag}.jar s3://${s3_bucket}/${project}/${environment}/'
        sh 'echo "==================deploy version: avatar-file-dataloader-${tag}.jar=============="'
      }
    }

    stage ('Deploy') {
      when {
        expression { params.lambda_deploy == 'true' }
      }
      steps {
        build (job: "${lambda_job_name}", wait: true,
        parameters: [
          string(name: 'environment', value: environment),
          string(name: 'region', value: region),
          string(name: 'lambda_s3_key', value: deploy_version),
        ])
      }
    }*/
  }
}